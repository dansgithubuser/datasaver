<!DOCTYPE html>
<html>

<head>
	<title>TTC data saver</title>
</head>

<body>
	track nearby TTC vehicles<br>
	lat: <input type='text' id='lat' value=43.645262><br>
	lon: <input type='text' id='lon' value=-79.382742><br>
	<input type='button' onclick='update()' value='update'><br>

	<canvas id="canvas" width="720" height="720">
		<p>Your browser does not support the canvas element.</p>
	</canvas><br>

	<script>
const ICON_SIZE = 4;
const PIXELS_PER_DEGREE = 2e4;

const gVehicles = {};
var gCanvas;
var gContext;
var gLat;
var gLon;

function e(id) { return document.getElementById(id); }
function v(id) { return e(id).value; }
function last(array){ return array[array.length - 1]; }

function drawRect(x, y, w, h, r, g, b) {
	gContext.fillStyle = `rgb(${r}, ${g}, ${b})`;
	gContext.fillRect(x, y, w, h);
}

function drawIcon(x, y, r = 255, g = 0, b = 0) {
	drawRect(
		x - ICON_SIZE / 2, y - ICON_SIZE / 2,
		ICON_SIZE, ICON_SIZE,
		r, g, b
	);
}

async function update() {
	// get info
	gLat = parseFloat(v('lat'));
	gLon = parseFloat(v('lon'));
	let url = window.location.href;
	if (!url.endsWith('/')) url += '/';
	url += `vehicles?lat=${gLat}&lon=${gLon}`;
	const response = await fetch(url);
	const vehicles = await response.json();
	for (const i in vehicles) {
		if (!(i in gVehicles)) gVehicles[i] = [];
		gVehicles[i].push(vehicles[i]);
	}
	// render
	gCanvas = e('canvas');
	gContext = canvas.getContext('2d');
	drawRect(0, 0, gCanvas.width, gCanvas.height, 0, 0, 0);// background
	drawIcon(canvas.width / 2, canvas.height / 2, 0, 255);// self
	for (const i of Object.values(gVehicles)) {
		const vehicle = last(i);
		const x = (vehicle.lon - gLon) * PIXELS_PER_DEGREE + gCanvas.width / 2;
		const y = -(vehicle.lat - gLat) * PIXELS_PER_DEGREE + gCanvas.height / 2;
		drawIcon(x, y);
		gContext.fillText(vehicle.routeId, x + ICON_SIZE, y);
	}
}

params = new URLSearchParams(window.location.search);
if (params.has('lat')) e('lat').value = params.get('lat');
if (params.has('lon')) e('lon').value = params.get('lon');

	</script>
</body>

</html>
